image: coq:8.5

stages:
  - iris
  - iris-atomic

iris:
  stage: iris
  tags:
  - coq
  script:
  - coqc -v
  # see if the Iris submodule needs cleaning, then build it
  - 'git submodule status iris | egrep "^ " || (git submodule update --init iris && cd iris && git clean -xfd)'
  - 'cd iris && make -j8'
  only:
  - master
  - ci

iris-atomic:
  stage: iris-atomic
  tags:
  - coq
  script:
  - coqc -v
  # prepare the environment, safeguard against outdated submodule
  - 'git submodule status iris | egrep "^ "'
  - 'ln -s iris iris-enabled'
  # build local repo
  - 'time make -j8'
  only:
  - master
  - ci
